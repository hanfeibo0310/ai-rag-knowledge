<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>知识库文件上传 - AI 服务平台</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Font Awesome 图标 -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- 自定义 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        dark: '#1e293b',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- 自定义样式 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .upload-area-hover {
                @apply border-primary bg-blue-50 transition-all duration-300;
            }
            .shadow-custom {
                @apply shadow-lg shadow-primary/20;
            }
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-medium py-2 px-6 rounded-lg transition-all duration-300 shadow-md hover:shadow-lg;
            }
            .input-custom {
                @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all duration-300;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen flex flex-col">
<!-- 头部导航 -->
<header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <i class="fa fa-database text-primary text-2xl"></i>
            <h1 class="text-xl font-bold text-dark">AI 知识库管理系统</h1>
        </div>
        <nav>
            <ul class="flex space-x-6">
                <li><a href="#" class="text-primary font-medium">文件上传</a></li>
                <li><a href="#" class="text-secondary hover:text-primary transition-colors">知识库列表</a></li>
                <li><a href="#" class="text-secondary hover:text-primary transition-colors">系统设置</a></li>
            </ul>
        </nav>
    </div>
</header>

<!-- 主要内容 -->
<main class="flex-grow container mx-auto px-4 py-8">
    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-custom p-6 md:p-8">
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-dark mb-2">知识库文件上传</h2>
            <p class="text-secondary">支持上传 md、txt、sql 格式文件，文件将自动解析并加入指定知识库</p>
        </div>

        <!-- 上传表单 -->
        <form id="uploadForm" class="space-y-6">
            <!-- 知识库名称输入 -->
            <div class="space-y-2">
                <label for="ragTag" class="block text-sm font-medium text-gray-700">
                    知识库名称 <span class="text-danger">*</span>
                </label>
                <input
                        type="text"
                        id="ragTag"
                        name="ragTag"
                        class="input-custom"
                        placeholder="请输入知识库名称（如：产品文档、技术手册）"
                        required
                >
            </div>

            <!-- 文件上传区域 -->
            <div class="space-y-2">
                <label class="block text-sm font-medium text-gray-700">
                    选择文件 <span class="text-danger">*</span>
                    <span class="text-xs text-gray-500 ml-2">支持格式：.md .txt .sql</span>
                </label>

                <!-- 拖拽上传区域 -->
                <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:upload-area-hover cursor-pointer transition-all duration-300">
                    <input
                            type="file"
                            id="fileInput"
                            name="files"
                            multiple
                            accept=".md,.txt,.sql"
                            class="hidden"
                    >
                    <div class="upload-icon mb-4">
                        <i class="fa fa-cloud-upload text-4xl text-gray-400"></i>
                    </div>
                    <p class="text-secondary mb-2">拖拽文件到此处，或</p>
                    <button type="button" id="selectFileBtn" class="btn-primary py-1 px-4 text-sm">
                        <i class="fa fa-file-o mr-2"></i>选择文件
                    </button>
                    <p id="fileListText" class="mt-4 text-sm text-gray-500 hidden">已选择文件：<span id="selectedFilesCount">0</span> 个</p>
                    <ul id="fileList" class="mt-3 text-left text-sm text-gray-600 max-h-40 overflow-y-auto hidden"></ul>
                </div>
            </div>

            <!-- 上传进度条 -->
            <div id="progressContainer" class="hidden space-y-2">
                <label class="block text-sm font-medium text-gray-700">上传进度</label>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progressBar" class="bg-primary h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-gray-600">0% 完成</p>
            </div>

            <!-- 提交按钮 -->
            <div class="pt-2">
                <button
                        type="submit"
                        id="submitBtn"
                        class="btn-primary w-full flex justify-center items-center"
                >
                    <i class="fa fa-upload mr-2"></i>开始上传
                </button>
            </div>
        </form>

        <!-- 提示消息 -->
        <div id="messageContainer" class="mt-6 hidden p-4 rounded-lg"></div>
    </div>
</main>

<!-- 页脚 -->
<footer class="bg-dark text-white py-6 mt-12">
    <div class="container mx-auto px-4 text-center text-sm">
        <p>© 2025 AI 知识库管理系统 - 版权所有</p>
        <p class="mt-1 text-gray-400">技术支持：AI 开发团队</p>
    </div>
</footer>

<!-- JavaScript 逻辑 -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 配置后端接口地址
        const UPLOAD_API_URL = 'http://localhost:8090/api/v1/rag/file/upload';
        // 超时时间：2分钟 = 120秒 = 120000毫秒（核心修改点）
        const UPLOAD_TIMEOUT = 120000;

        // 获取DOM元素
        const uploadForm = document.getElementById('uploadForm');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');
        const ragTagInput = document.getElementById('ragTag');
        const fileListText = document.getElementById('fileListText');
        const fileList = document.getElementById('fileList');
        const selectedFilesCount = document.getElementById('selectedFilesCount');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const submitBtn = document.getElementById('submitBtn');
        const messageContainer = document.getElementById('messageContainer');

        // 存储选中的文件
        let selectedFiles = [];

        // 选择文件按钮点击事件
        selectFileBtn.addEventListener('click', function(e) {
            e.preventDefault();
            fileInput.click();
        });

        // 文件选择事件
        fileInput.addEventListener('change', function() {
            handleFiles(this.files);
        });

        // 拖拽上传事件
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('upload-area-hover');
        });

        uploadArea.addEventListener('dragleave', function() {
            uploadArea.classList.remove('upload-area-hover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('upload-area-hover');
            handleFiles(e.dataTransfer.files);
        });

        // 处理选中的文件
        function handleFiles(files) {
            if (files.length === 0) return;

            // 过滤支持的文件类型
            const allowedTypes = ['text/markdown', 'text/plain', 'application/sql', '.md', '.txt', '.sql'];
            selectedFiles = Array.from(files).filter(file => {
                const ext = '.' + file.name.split('.').pop().toLowerCase();
                return allowedTypes.includes(file.type) || allowedTypes.includes(ext);
            });

            // 更新文件列表显示
            selectedFilesCount.textContent = selectedFiles.length;
            fileListText.classList.remove('hidden');
            fileList.classList.remove('hidden');
            fileList.innerHTML = '';

            if (selectedFiles.length === 0) {
                fileList.innerHTML = '<li class="text-danger">未选择有效文件（仅支持 md、txt、sql 格式）</li>';
                return;
            }

            // 显示选中的文件列表
            selectedFiles.forEach((file, index) => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center py-1 border-b border-gray-100';
                li.innerHTML = `
                    <span><i class="fa fa-file-text-o mr-2 text-primary"></i>${file.name}</span>
                    <span class="text-xs text-gray-500">${formatFileSize(file.size)}</span>
                `;
                fileList.appendChild(li);
            });
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 表单提交事件
        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            // 验证
            const ragTag = ragTagInput.value.trim();
            if (!ragTag) {
                showMessage('请输入知识库名称', 'danger');
                return;
            }
            if (selectedFiles.length === 0) {
                showMessage('请选择要上传的文件', 'danger');
                return;
            }

            // 创建FormData
            const formData = new FormData();
            formData.append('ragTag', ragTag);
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });

            // 显示进度条
            progressContainer.classList.remove('hidden');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>上传中...';
            clearMessage();

            try {
                // 发送上传请求 - 超时时间改为2分钟
                // 找到前端fetch请求部分，确保配置如下：
const response = await fetch(UPLOAD_API_URL, {
    method: 'POST',
    body: formData,
    mode: 'cors', // 明确跨域模式（必须）
    credentials: 'include', // 携带凭证（与后端allowCredentials对应）
    signal: AbortSignal.timeout(UPLOAD_TIMEOUT)
});

                // 第一步：检查响应状态
                if (!response.ok) {
                    let errorText = '';
                    const contentType = response.headers.get('content-type');

                    // 解析不同类型的错误响应
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        errorText = `[${response.status}] ${errorData.info || '请求失败'}`;
                    } else {
                        const responseText = await response.text();
                        // 提取HTML错误中的关键信息
                        if (responseText.includes('<title>')) {
                            const titleMatch = responseText.match(/<title>(.*?)<\/title>/);
                            if (titleMatch && titleMatch[1]) {
                                errorText = `[${response.status}] ${titleMatch[1]}`;
                            } else {
                                errorText = `[${response.status}] 服务器返回错误页面`;
                            }
                        } else {
                            errorText = `[${response.status}] ${responseText.substring(0, 100)}...`;
                        }
                    }
                    throw new Error(errorText);
                }

                // 第二步：解析JSON响应
                const result = await response.json();

                // 处理业务响应
                if (result.code === '0000') {
                    showMessage(`文件上传成功！已加入知识库「${ragTag}」`, 'success');
                    resetForm();
                } else {
                    showMessage(`上传失败：${result.info || '未知业务错误'}`, 'danger');
                }

            } catch (error) {
                // 分类处理错误
                let errorMsg = '';
                if (error.name === 'AbortError') {
                    errorMsg = `上传超时！（超时时间：${UPLOAD_TIMEOUT/1000}秒）请检查网络或后端服务是否正常`;
                } else if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    errorMsg = '跨域错误或后端服务不可用！请检查：1. 后端是否启动 2. 跨域配置是否正确 3. 接口地址是否正确';
                } else if (error.message.includes('Unexpected token')) {
                    errorMsg = '后端响应格式错误！请检查后端接口是否返回合法JSON';
                } else {
                    errorMsg = `上传出错：${error.message}`;
                }
                showMessage(errorMsg, 'danger');
                console.error('上传错误详情：', error);
            } finally {
                // 重置状态
                progressBar.style.width = '0%';
                progressText.textContent = '0% 完成';
                progressContainer.classList.add('hidden');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-upload mr-2"></i>开始上传';
            }
        });

        // 显示提示消息
        function showMessage(text, type) {
            messageContainer.textContent = text;
            messageContainer.classList.remove('hidden', 'bg-success', 'bg-danger', 'bg-warning');

            if (type === 'success') {
                messageContainer.classList.add('bg-success', 'text-white');
                // 成功消息3秒后自动隐藏
                setTimeout(() => {
                    messageContainer.classList.add('hidden');
                }, 3000);
            } else if (type === 'danger') {
                messageContainer.classList.add('bg-danger', 'text-white');
            } else if (type === 'warning') {
                messageContainer.classList.add('bg-warning', 'text-dark');
            }
        }

        // 清除提示消息
        function clearMessage() {
            messageContainer.classList.add('hidden');
            messageContainer.textContent = '';
        }

        // 重置表单
        function resetForm() {
            ragTagInput.value = '';
            fileInput.value = '';
            selectedFiles = [];
            fileListText.classList.add('hidden');
            fileList.classList.add('hidden');
            fileList.innerHTML = '';
            selectedFilesCount.textContent = '0';
        }

        // 修复部分浏览器fetch上传进度事件支持问题
        if (!XMLHttpRequest.prototype.hasOwnProperty('upload')) {
            XMLHttpRequest.prototype.upload = {
                addEventListener: function() {}
            };
        }
    });
</script>
</body>
</html>