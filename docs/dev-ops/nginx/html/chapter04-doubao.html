<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI对话助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        assistant: '#f1f5f9',
                        user: '#dbeafe',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .message-animation {
                animation: fadeIn 0.3s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(5px); }
                to { opacity: 1; transform: translateY(0); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
<!-- 顶部导航 -->
<header class="bg-white shadow-sm py-4 px-6">
    <div class="max-w-4xl mx-auto flex justify-between items-center">
        <h1 class="text-xl font-bold text-primary flex items-center">
            <i class="fa fa-robot mr-2"></i>AI对话助手
        </h1>
        <div class="text-sm text-gray-500">
                <span id="status" class="inline-flex items-center">
                    <i class="fa fa-circle text-green-500 animate-pulse mr-1"></i>已连接
                </span>
        </div>
    </div>
</header>

<!-- 主内容区 -->
<main class="flex-1 max-w-4xl w-full mx-auto px-4 py-6 overflow-hidden flex flex-col">
    <!-- 对话区域 -->
    <div id="chat-container" class="flex-1 overflow-y-auto scrollbar-hide space-y-6 mb-6">
        <!-- 欢迎消息 -->
        <div class="message-animation">
            <div class="flex items-start">
                <div class="flex-shrink-0 h-8 w-8 rounded-full bg-primary flex items-center justify-center text-white mr-3">
                    <i class="fa fa-robot"></i>
                </div>
                <div class="bg-assistant rounded-lg px-4 py-3 rounded-tl-none max-w-[85%]">
                    <p class="text-gray-800">你好！我是AI助手，有什么我可以帮助你的吗？</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 输入区域 -->
    <div class="bg-white rounded-lg shadow-md p-4">
        <form id="chat-form" class="flex flex-col space-y-3">
            <div class="flex items-center space-x-2">
                <label for="model" class="text-sm text-gray-600">模型:</label>
                <select id="model" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
                    <option value="deepseek-r1:1.5b">deepseek-r1:1.5b</option>
                    <option value="llama3:8b">llama3:8b</option>
                    <option value="gemma:7b">gemma:7b</option>
                </select>
            </div>

            <div class="flex items-center space-x-3">
                    <textarea
                            id="message-input"
                            rows="2"
                            placeholder="请输入你的问题..."
                            class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary resize-none"
                            required
                    ></textarea>
                <button
                        type="submit"
                        id="send-button"
                        class="bg-primary hover:bg-primary/90 text-white rounded-md px-4 py-2 flex items-center justify-center transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <i class="fa fa-paper-plane mr-1"></i>发送
                </button>
            </div>

            <div class="text-xs text-gray-500">
                <p>提示：支持流式响应，消息会实时显示</p>
            </div>
        </form>
    </div>
</main>

<!-- 页脚 -->
<footer class="bg-white py-4 px-6 text-center text-sm text-gray-500">
    <p>© 2025 AI对话助手 | 使用Spring AI和Ollama提供支持</p>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const chatForm = document.getElementById('chat-form');
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const modelSelect = document.getElementById('model');
        const sendButton = document.getElementById('send-button');

        // 添加用户消息到聊天界面
        function addUserMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-animation';
            messageDiv.innerHTML = `
                <div class="flex items-start justify-end">
                    <div class="bg-user rounded-lg px-4 py-3 rounded-tr-none max-w-[85%]">
                        <p class="text-gray-800">${escapeHtml(message)}</p>
                    </div>
                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-gray-700 flex items-center justify-center text-white ml-3">
                        <i class="fa fa-user"></i>
                    </div>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 添加AI消息到聊天界面（流式）
        function addAiMessageStream() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message-animation';
            messageDiv.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-shrink-0 h-8 w-8 rounded-full bg-primary flex items-center justify-center text-white mr-3">
                        <i class="fa fa-robot"></i>
                    </div>
                    <div class="bg-assistant rounded-lg px-4 py-3 rounded-tl-none max-w-[85%]">
                        <p class="text-gray-800 ai-response"></p>
                        <div class="typing-indicator hidden mt-2">
                            <span class="inline-block w-2 h-2 bg-gray-400 rounded-full mr-1 animate-bounce" style="animation-delay: 0s"></span>
                            <span class="inline-block w-2 h-2 bg-gray-400 rounded-full mr-1 animate-bounce" style="animation-delay: 0.2s"></span>
                            <span class="inline-block w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                        </div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // 返回消息元素，用于更新内容
            return {
                element: messageDiv.querySelector('.ai-response'),
                typingIndicator: messageDiv.querySelector('.typing-indicator'),
                showTyping: function() { this.typingIndicator.classList.remove('hidden'); },
                hideTyping: function() { this.typingIndicator.classList.add('hidden'); },
                appendContent: function(content) {
                    if (content) {
                        this.element.innerHTML += escapeHtml(content);
                    }
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            };
        }

        // HTML转义
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // 表单提交处理
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const message = messageInput.value.trim();
            const model = modelSelect.value;

            if (!message) return;

            // 添加用户消息
            addUserMessage(message);

            // 清空输入框
            messageInput.value = '';

            // 添加AI响应容器
            const aiMessage = addAiMessageStream();
            aiMessage.showTyping();

            // 禁用发送按钮
            sendButton.disabled = true;

            try {
                // 构建API URL
                const apiUrl = `http://localhost:8090/api/v1/ollama/generate_stream?model=${encodeURIComponent(model)}&message=${encodeURIComponent(message)}`;

                // 创建EventSource连接
                const eventSource = new EventSource(apiUrl);

                // 处理消息事件
                eventSource.onmessage = (event) => {
                    try {
                        // 解析服务器发送的消息
                        const data = JSON.parse(event.data);

                        // 从响应中提取内容
                        if (data && data.result) {
                            const content = data.result.output?.content;
                            const finishReason = data.result.metadata?.finishReason;

                            // 更新AI响应内容
                            aiMessage.appendContent(content);

                            // 检查是否结束
                            if (finishReason === 'STOP') {
                                aiMessage.hideTyping();
                                eventSource.close();
                                sendButton.disabled = false;
                            }
                        }
                    } catch (error) {
                        console.error('解析消息失败:', error);
                    }
                };

                // 处理错误
                eventSource.onerror = (error) => {
                    console.error('EventSource错误:', error);
                    //aiMessage.appendContent('\n\n连接错误，请重试。');
                    aiMessage.hideTyping();
                    eventSource.close();
                    sendButton.disabled = false;
                };

            } catch (error) {
                console.error('请求错误:', error);
                //aiMessage.appendContent('\n\n请求错误，请重试。');
                aiMessage.hideTyping();
                sendButton.disabled = false;
            }
        });

        // 自动调整文本框高度
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = (messageInput.scrollHeight) + 'px';
        });

        // 按Ctrl+Enter发送消息
        messageInput.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                chatForm.dispatchEvent(new Event('submit'));
            }
        });
    });
</script>
</body>
</html>